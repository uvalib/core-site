<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/uvalib-theme/uvalib-theme.html">
<link rel="import" href="../bower_components/uvalib-theme/uvalib-card-style.html">
<link rel="import" href="../bower_components/uvalib-theme/uvalib-ui-element.html" />
<script src="../bower_components/iframe-resizer/js/iframeResizer.min.js"></script>

<!-- EXHIBITION FONT -->
<link href="https://fonts.googleapis.com/css?family=Arima+Madurai" rel="stylesheet">
<!-- END -->

<dom-module id="uvalib-article">

  <link rel="lazy-import" group="uvalib-article-notsmall" href="../bower_components/uvalib-chat/uvalib-chat.html">
  <link rel="lazy-import" group="uvalib-article" href="app-side-bar.html">
  <link rel="lazy-import" group="uvalib-article" href="app-sub-nav.html">
  <link rel="lazy-import" group="uvalib-article2" href="news-network-warning.html">

  <template>
    <custom-style>
      <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors uvalib-card-style">
        :host {
          display: block;
          @apply --layout-horizontal;
          /*@apply --layout-wrap;*/
          @apply --layout-center-justified;
        }

        [hidden] {
          display: none !important;
        }

        .container {
            width: 100%;
        }

        .container {
          min-height: 100vh;
          max-width: var(--uvalib-display-width-max);
          /*@apply --layout-flex;*/
          width: 100%;
          @apply --layout-horizontal;
          @apply --layout-wrap;
        }

        .container .fade-in {
          opacity: 0;
        }

        .container[fade-in] .fade-in {
          opacity: 1;
          transition: opacity 500ms;
        }

        article {
          @apply --layout-flex;
          /*width: 100%;*/
        }
        aside {
          margin-left: 24px;
          width: 300px;
        }

        app-side-bar, app-sub-nav {
          margin-bottom: 32px;
        }

        iframe {
          width: 1px;
          min-width: 100%;
          height: 500px;
        }

        /* EXHIBITION TEMPLATE */
        :host([type='exhibit']) #pagetitle {display: none;}
        .exhibition-template paper-button { background: white !important; }

        .exhibit-header { margin-top: -1px; height: 520px; overflow-y: hidden; }
        .exhibit-main-image { float: left; }
        .exhibit-main-image figure { margin: 0; }
        .exhibit-welcome { float: right; width: 43%; padding: 30px; line-height: 1.5; }
        .exhibit-welcome .header-label { font-size: 16px; font-weight: 300; text-transform: uppercase; margin-top: 0; }
        .exhibit-welcome .header-title { line-height: 1.25; font-size: 32px; margin-top: 0; padding-top: var(--uvalib-spacing-unit); }
        .exhibit-welcome .header-supporting-text { margin:0; font-size: 21px; }
        .exhibit-date-range { font-size: 24px; font-weight: 500; padding-top: calc(var(--uvalib-spacing-unit)*2); }
        .exhibit-location { font-size: 16px; font-weight: 400; padding-top: calc(var(--uvalib-spacing-unit)/2); }
        .exhibit-button-group { padding-top: calc(var(--uvalib-spacing-unit)*2.25); }

        .exhibit-book-tour { border: 1px dotted green; height: 100%; padding: var(--uvalib-spacing-unit); }
        .exhibit-book-tour p {text-align: center;}
        .exhibit-overview { border: 1px dashed red; padding: var(--uvalib-spacing-unit); }
        .exhibit-collapse-link { float: right; text-transform: uppercase; }
        .exhibit-gallery-info, .exhibit-news { padding-top: 20px; padding-bottom: 20px; }
        .exhibit-book-tour h2, .exhibit-overview h2:first-of-type, .exhibit-gallery-info h2, .exhibit-news h2 { text-align: center; }
        .exhibit-gallery-item, .exhibit-news-item { padding: var(--uvalib-spacing-unit); width: 540px; border-radius: 5px; }
        .exhibit-gallery-item { padding-top: 20px;  height: 175px; }
        .exhibit-gallery-item .fred { height: 100%; }
        .exhibit-card-title { flex-grow: 0; font-size: 24px; font-weight: 600; text-transform: none; padding-bottom: calc(var(--uvalib-spacing-unit)/3);}
        .exhibit-card-content { flex-grow: 1; line-height: 1.5;}
        .exhibit-card-link { margin-top: 20px; text-transform: uppercase;}

        .exhibit-news-item { height: 150px; }
        .exhibit-card-news-source { padding-bottom: calc(var(--uvalib-spacing-unit)/3); text-transform: capitalize; }
        .exhibit-card-news-title { padding-bottom: calc(var(--uvalib-spacing-unit)/3); font-size: 24px; font-weight: 400; text-transform: capitalize; }
        .exhibit-card-news-copy {}

        .exhibit-pre-footer { padding-top: calc(var(--uvalib-spacing-unit)*1.25); padding-bottom: calc(var(--uvalib-spacing-unit)*1.25); text-align: center; }
        .exhibit-pre-footer a:first-child { margin-right: calc(var(--uvalib-spacing-unit)*2.5);}

        /*MEDIUM BREAKPOINT*/
        :host([medium-screen]) .exhibit-header  { height: 100%; }
        :host([medium-screen]) .exhibit-main-image  { float: none; }
        :host([medium-screen]) .exhibit-welcome { float: none; }
        :host([medium-screen]) .exhibit-gallery-item, :host([medium-screen]) .exhibit-news-item { width: 330px; height: 200px; }

        /*SMALL BREAKPOINT*/
        :host([small-screen]) .exhibit-header  { height: 100%; }
        :host([small-screen]) .exhibit-main-image  { float: none; }
        :host([small-screen]) .exhibit-welcome { float: none; }
        :host([small-screen]) .exhibit-gallery-info, :host([small-screen]) .exhibit-news, :host([small-screen]) .exhibit-overview, :host([small-screen]) .exhibit-book-tour { width: 100%; }
        :host([small-screen]) .exhibit-gallery-item, :host([medium-screen]) .exhibit-news-item { width: 100%; height: 200px; }

        /*CUSTOM STYLES HANDLED THROUGH DRUPAL*/
        /* cusotom font */
        .exhibition-template, h1, h2, h3, h4, h5, paper-card, paper-button, a { font-family: 'Arima Madurai', cursive; }
        /* header background color */
        .exhibit-header { background-color: teal; }
        /* header font colors */
        .exhibit-welcome, .exhibit-welcome h1 { color: orange; }
        /* 'Gallery Info' section background color */
        .exhibit-gallery-info { background-color: var(--uvalib-grey-600); }
        .exhibit-gallery-info h2 { color: var(--uvalib-white); }
        /* 'In the news' background color */
        .exhibit-news { background-color: var(--uvalib-grey-300); }
        /* 'In the news' copy color */
        .exhibit-news-item { color: var(--uvalib-grey-600); }
        /* 'In the news' article source color */
        .exhibit-card-news-source { color: var(--uvalib-main-rotunda-orange); }
        /* Pre-footer background color */
        .exhibit-pre-footer { background-color: #613D0C; }


      </style>
    </custom-style>

    <template is="dom-if" if="[[!smallScreen]]">
      <uvalib-chat></uvalib-chat>
    </template>


    <app-route
        route="{{route}}"
        pattern="/:category/:id"
        data="{{_routeData}}"></app-route>

    <div role="main" class="container" fade-in$="[[!loading]]" hidden$="[[failure]]" on-click-hash-link="_hashClick">
      <article>
        <div id="content" class="fade-in" on-click="_click"></div>
      </article>

      <template is="dom-if" if="[[_or( article.sidebar, article.subnav)]]">
        <aside>
          <template is="dom-if" if="[[article.subnav]]">
            <app-sub-nav small-screen$="[[smallScreen]]" medium-screen$="[[mediumScreen]]" large-screen$="[[largeScreen]]" class="fade-in" uuid="[[article.subnav]]"></app-sub-nav>
          </template>
          <template is="dom-if" if="[[article.sidebar]]">
            <app-side-bar small-screen$="[[smallScreen]]" medium-screen$="[[mediumScreen]]" large-screen$="[[largeScreen]]" class="fade-in" uuid="[[article.sidebar]]">
            </app-side-bar>
          </template>
        </aside>
      </template>

    </div>

    <news-network-warning
        hidden$="[[!failure]]"
        offline="[[offline]]"
        on-try-reconnect="_tryReconnect"></news-network-warning>

  </template>

  <script>

    class UvaLibArticle extends UvalibUiElement {

      static get is() { return 'uvalib-article'; }

      static get properties() {

        return Object.assign(super.properties,
            {
              route: Object,

              category: Object,

              article: Object,

              loading: Boolean,

              offline: Boolean,

              failure: Boolean,

              categoryName: {
                type: Boolean,
                computed: '_return(_routeData.category)',
                notify: true
              },

              articleId: {
                type: Boolean,
                computed: '_return(_routeData.id)',
                notify: true
              },

              _routeData: Object,

              tabindex: {
                type: Number,
                value: -1
              },

              type: {
                reflectToAttribute: true,
                computed: '_getType(article.type)'
              }
            });

      }

      static get observers() { return [
        '_loadArticle(article.headline,article.html,article.extra,article.type)',
        '_articleChanged(article)',
        '_loadChat(mediumScreen,largeScreen)'
      ]}

      //Concat the this elements template with the parents
      static get template() {
        var parentTemplate = UvalibUiElement.template.cloneNode(true);
        var childTemplate = Polymer.DomModule.import('uvalib-article', 'template');
        parentTemplate.content.insertBefore(childTemplate.content,null);
        return parentTemplate;
      }

      connectedCallback() {
        super.connectedCallback();

        Polymer.RenderStatus.afterNextRender(this, this._installListeners);

        this.importLazyGroup('uvalib-article').then( function(results) {
          this.importLazyGroup('uvalib-article2');
        }.bind(this));
      }

      changeFocusToContent() {
        // For the home page focus should be directed to the banner.
        // For any other page focus should go to the heading.
        // NOTE for this to work these elements need to have tabindex=-1
        if (this.shadowRoot.querySelector('uvalib-homepage')) {
          console.log('banner');
          this.shadowRoot.querySelector('uvalib-homepage').setBannerFocus();
        } else {
          if (this.shadowRoot.querySelector('h1')) {
            this.shadowRoot.querySelector('h1').focus();
          }
        }
      }

      _getType(type) {
        if (type) return type;
      }
      _loadChat(mediumScreen,largeScreen) {
        if (mediumScreen || largeScreen) this.importLazyGroup('uvalib-article-notsmall');
      }

      _installListeners() {
        this._desktopMediaQuery = window.matchMedia('(min-width: 768px)');
      }

      _translate(elem, x, y, transition) {
        elem.style.display = 'block';
        elem.style.transition = transition ? 'transform 0.2s' : '';
        elem.style.transform = 'translate3d(' + x + 'px,' + y + 'px,0)';
      }

      _resetElementStyles(elem) {
        elem.style.display = '';
        elem.style.transition = '';
        elem.style.transform = '';
      }

      _swapCurrentArticleCovers(newCover) {
        const oldCover = this._currentArticleCover;
        oldCover.classList.remove('fade-in');
        oldCover.classList.add('preview-cover');

        this._resetElementStyles(newCover);
        newCover.classList.remove('preview-cover');
        this._currentArticleCover = newCover;
        newCover.parentElement.insertBefore(newCover, oldCover);

        return oldCover;
      }

      _isDesktopWidth() {
        return this._desktopMediaQuery.matches;
      }

      _loadArticle(title,html) {
        // Remove any old iframes if we have them
        var ifrm = this.shadowRoot.getElementById('ifrm');
        if (ifrm && ifrm.iFrameResizer) {
          ifrm.iFrameResizer.close();
        }

        // If this._currentArticleCover isn't defined here, then it hasn't been stamped yet, and
        // the template already has the `fade-in` class.
        if (this._currentArticleCover) {
          this._currentArticleCover.classList.add('fade-in');
        }

        if (this.article && this.article.iframe && this.article.path) {
          console.log("loading iframe: /data/pages"+this.article.path);
          this.$.content.innerHTML = "<h1 id='pagetitle' tabindex='-1'>"+title+"</h1><iframe id='ifrm' src='https://static.lib.virginia.edu/drupalPages"+this.article.path+"' scrolling='no' frameBorder='0'></iframe>";
          setTimeout(function(){iFrameResize({log:true,checkOrigin:false}, this.shadowRoot.getElementById('ifrm'))}.bind(this),2000);
        }
        else if (title && html) {
          if (this.route.prefix==="/" && this.route.path==="") {
            this.$.content.innerHTML = html;
          } else {
            this.$.content.innerHTML = "<h1 id='pagetitle' tabindex='-1'>"+title+"</h1>"+html;
          }
        }
        // handle anchors
        this._handleAnchor();
      }

      _articleChanged(article) {
        // If this._currentArticleCover isn't defined here, then `attached()` (which hasn't been
        // run yet) will set the article.
        if (this._currentArticleCover) {
          this._currentArticleCover.article = article;
        }
      }

      _tryReconnect() {
        this.dispatchEvent(new CustomEvent('refresh-data', {bubbles: true, composed: true}));
      }

      _slice(list, begin, end) {
        if (list) {
          return list.slice(begin, end);
        }
      }

      _return(value) {
        return value;
      }

      _hashClick(e){
        this._scrollToSelector(e.detail.anchor);
      }

      _click(e) {
        var target = e.target
        if (target.tagName.toLowerCase() === "a" && target.getAttribute('href')[0]==="#") {
          e.preventDefault();
          this._scrollToSelector(target.getAttribute('href'));
        }
      }
    }

    customElements.define(UvaLibArticle.is, UvaLibArticle);

  </script>

</dom-module>
